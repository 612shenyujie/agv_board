# MScB 通讯协议

## 一、协议结构

MScB通信为CAN 2.0通信接口，波特率1Mbps，采用扩展帧格式，如下所示：

<div>			<!--块级封装-->     
    <center>	<!--将图片和文字居中-->    
        <img src="https://yins-typora.oss-cn-zhangjiakou.aliyuncs.com/img/image-20231221212905765.png"          
             alt="MScB_Frame_Distribution"          
             style="zoom:50%"/>     
        <br>		<!--换行-->     CAN通讯数据格式图	<!--标题-->     
    </center> 
</div>

所有的数据域中都是MSB在前，LSB在后。

## 二、指令一览

### PID指令类

| 指令ID |              指令参数               |                           指令含义                           |
| :----: | :---------------------------------: | :----------------------------------------------------------: |
|  0x30  |      GET_PID_PARAMETER_PI_GAIN      | 获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数 |
|  0x31  |      GET_PID_PARAMETER_PD_GAIN      | 获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PD 参数 |
|  0x32  |      SET_PID_PARAMETER_PI_GAIN      | 设置某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数 |
|  0x33  |      SET_PID_PARAMETER_PD_GAIN      |  设置某个舵轮转向电机角度环、速度环控制的积分上限、输出上限  |
|  0x34  | GET_MOTION_PART_PID_PARAMETER_LIMIT |      获取某个舵轮动力电机速度环控制的积分上限、输出上限      |
|        |                                     |                                                              |

## 三、指令详述

### PID指令类

#### 0x01 GET_PID_PARAMETER_PI_GAIN

作用：获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数

|          数据区段           |                 内容                  | 数据类型  |
| :-------------------------: | :-----------------------------------: | :-------: |
|           cmd_id            |                 0x01                  | uint8_t:5 |
|  数据区 2 的 Bit7 ~ Bit 0   |      loop_offset_id（详见下方）       |  uint8_t  |
|           目标 ID           |               舵轮的 ID               |  uint8_t  |
| 数据区 1 的 Byte 7 ~ Byte 6 |         电机 PID 某个环的 Ki          |  int16_t  |
| 数据区 1 的 Byte 5 ~ Byte 4 |  电机 PID 某个环的积分环节2次方增益   |  int16_t  |
| 数据区 1 的 Byte 3 ~ Byte 2 |         电机 PID 某个环的 Kp          |  int16_t  |
| 数据区 1 的 Byte 1 ~ Byte 0 | 电机 PID 某个环的比例环节的 2次方增益 |  int16_t  |

> 注意是数据区 2 的 Bit 位数，而非拓展帧的 Bit 位数。以下内容同理，恕不再赘述。

| loop_offset_id |           内容           |
| :------------: | :----------------------: |
|      0x01      | 指定查询转向电机的角度环 |
|      0x02      | 指定查询转向电机的速度环 |
|      0x03      | 指定查询动力电机的角度环 |
|      0x04      | 指定查询动力电机的速度环 |

#### 0x02 GET_PID_PARAMETER_PD_GAIN

作用：获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数



|          数据区段           |                 内容                  | 数据类型  |
| :-------------------------: | :-----------------------------------: | :-------: |
|           cmd_id            |                 0x02                  | uint8_t:5 |
|  数据区 2 的 Bit7 ~ Bit 0   |      loop_offset_id（详见下方）       |  uint8_t  |
|           目标 ID           |               舵轮的 ID               |  uint8_t  |
| 数据区 1 的 Byte 7 ~ Byte 6 |         电机 PID 某个环的 Kd          |  int16_t  |
| 数据区 1 的 Byte 5 ~ Byte 4 |  电机 PID 某个环的微分环节2次方增益   |  int16_t  |
| 数据区 1 的 Byte 3 ~ Byte 2 |         电机 PID 某个环的 Kp          |  int16_t  |
| 数据区 1 的 Byte 1 ~ Byte 0 | 电机 PID 某个环的比例环节的 2次方增益 |  int16_t  |

| loop_offset_id |           内容           |
| :------------: | :----------------------: |
|      0x01      | 指定查询转向电机的角度环 |
|      0x02      | 指定查询转向电机的速度环 |
|      0x03      | 指定查询动力电机的角度环 |
|      0x04      | 指定查询动力电机的速度环 |

#### 0x03 GET_PID_PARAMETER_LIMIT

作用：获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数

|          数据区段           |            内容            | 数据类型  |
| :-------------------------: | :------------------------: | :-------: |
|           cmd_id            |            0x03            | uint8_t:5 |
|  数据区 2 的 Bit15 ~ Bit 8  | term_offset_id（详见下方） |  uint8_t  |
|  数据区 2 的 Bit7 ~ Bit 0   | loop_offset_id（详见下方） |  uint8_t  |
|           目标 ID           |         舵轮的 ID          |  uint8_t  |
| 数据区 1 的 Byte 7 ~ Byte 4 | 电机 PID 某个环的积分上限  |  uint8_t  |
| 数据区 1 的 Byte 3 ~ Byte 0 | 电机 PID 某个环的积分上限  |  uint8_t  |

| loop_offset_id |           内容           |
| :------------: | :----------------------: |
|      0x01      | 指定查询转向电机的角度环 |
|      0x02      | 指定查询转向电机的速度环 |
|      0x03      | 指定查询动力电机的角度环 |
|      0x04      | 指定查询动力电机的速度环 |

| term_offset_id |              内容              |
| :------------: | :----------------------------: |
|      0x01      |      指定查询输出的限制值      |
|      0x02      | 指定查询比例、微分环节的限制值 |
|      0x03      |    指定查询积分环节的限制值    |
