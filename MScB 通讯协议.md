# MScB 通讯协议

## 一、协议结构

MScB通信为CAN 2.0通信接口，波特率1Mbps，采用扩展帧格式，如下所示：

<div>			<!--块级封装-->     
    <center>	<!--将图片和文字居中-->    
        <img src="https://yins-typora.oss-cn-zhangjiakou.aliyuncs.com/img/image-20231221212905765.png"          
             alt="MScB_Frame_Distribution"          
             style="zoom:50%"/>     
        <br>		<!--换行-->     CAN通讯数据格式图	<!--标题-->     
    </center> 
</div>

所有的数据域中都是MSB在前，LSB在后。

## 二、指令一览

### PID指令类

| 指令ID |              指令参数               |                           指令含义                           |
| :----: | :---------------------------------: | :----------------------------------------------------------: |
|  0x30  |      GET_PID_PARAMETER_PI_GAIN      | 获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数 |
|  0x31  |      GET_PID_PARAMETER_PD_GAIN      | 获取某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PD 参数 |
|  0x32  |      SET_PID_PARAMETER_PI_GAIN      | 设置某个舵轮转向电机角度环 / 转向电机速度环控制 / 动力电机角度环 / 动力电机速度环的 PI 参数 |
|  0x33  |      SET_PID_PARAMETER_PD_GAIN      |  设置某个舵轮转向电机角度环、速度环控制的积分上限、输出上限  |
|  0x34  | GET_MOTION_PART_PID_PARAMETER_LIMIT |      获取某个舵轮动力电机速度环控制的积分上限、输出上限      |
|        |                                     |                                                              |

## 三、指令详述

### PID指令类

#### 0x01 GET_PID_PARAMETER

作用：获取某个舵轮的指定 PID 参数

|         数据区段          |            内容            | 数据类型  |
| :-----------------------: | :------------------------: | :-------: |
|          cmd_id           |            0x01            | uint8_t:5 |
| 数据区 2 的 Bit15 ~ Bit 8 | term_offset_id（详见下方） |  uint8_t  |
| 数据区 2 的 Bit7 ~ Bit 0  | loop_offset_id（详见下方） |  uint8_t  |
|          目标 ID          |         舵轮的 ID          |  uint8_t  |
|         数据区 1          |    返回数据（详见下方）    |  int16_t  |

> 注意是数据区 2 的 Bit 位数，而非拓展帧的 Bit 位数。以下内容同理，恕不再赘述。

| loop_offset_id |           内容           |
| :------------: | :----------------------: |
|      0x01      | 指定查询转向电机的角度环 |
|      0x02      | 指定查询转向电机的速度环 |
|      0x03      | 指定查询动力电机的角度环 |
|      0x04      | 指定查询动力电机的速度环 |

| term_offset_id |         内容          |
| :------------: | :-------------------: |
|      0x01      | 指定查询 PID 输出环节 |
|      0x02      | 指定查询 PID 比例环节 |
|      0x03      | 指定查询 PID 积分环节 |
|      0x04      | 指定查询 PID 微分环节 |

##### PID 输出环节

当获取某个舵轮的指定 PID 输出环节参数时，数据区 1 的内容满足如下：

|  数据区 1 区段  |     内容     | 数据类型 |
| :-------------: | :----------: | :------: |
| Byte 3 ~ Byte 2 | 输出限幅下限 | int16_t  |
| Byte 1 ~ Byte 0 | 输出限幅上限 | int16_t  |

##### PID 比例环节

当获取某个舵轮的指定 PID 比例环节参数时，数据区 1 的内容满足如下：

|  数据区 1 区段  |              内容              | 数据类型 |
| :-------------: | :----------------------------: | :------: |
| Byte 3 ~ Byte 2 | 比例环节二的次方输出放大幂次数 | uint16_t |
| Byte 1 ~ Byte 0 |       比例环节系数$K_p$        | int16_t  |

> 💡	比例环节二的次方输出放大幂次数如果是$n$且$n \not = 0$，原$P_{out} = K_p \cdot err$；那么新的$P_{out} = 2^n \cdot K_p \cdot err$

##### PID 积分环节

当获取某个舵轮的指定 PID 积分环节参数时，数据区 1 的内容满足如下：

|  数据区 1 区段  |              内容              | 数据类型 |
| :-------------: | :----------------------------: | :------: |
| Byte 7 ~ Byte 6 | 积分环节二的次方输出放大幂次数 | uint16_t |
| Byte 5 ~ Byte 4 |        积分环节输出下限        | int16_t  |
| Byte 3 ~ Byte 2 |        积分环节输出上限        | int16_t  |
| Byte 1 ~ Byte 0 |       积分环节系数$K_i$        | int16_t  |

##### PID 微分环节

当获取某个舵轮的指定 PID 微分环节参数时，数据区 1 的内容满足如下：

|  数据区 1 区段  |              内容              | 数据类型 |
| :-------------: | :----------------------------: | :------: |
| Byte 3 ~ Byte 2 | 微分环节二的次方输出放大幂次数 | uint16_t |
| Byte 1 ~ Byte 0 |       微分环节系数$K_d$        | int16_t  |

